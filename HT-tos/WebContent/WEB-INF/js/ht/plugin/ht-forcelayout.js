!function(B,C){"use strict";var l="ht",I=l+".layout.",M=B[l]||module.parent.exports.ht,a=M.List,H=M.DataModel,e=M.Node,t=M.Edge,b=M.Group,m=Math,x=m.sqrt,T=m.random,n=m.max,V=m.min,q=function(F){return F*F};M.Default.getInternal().addMSMap({ms_force:function(f){f._interval=50,f._stepCount=10,f._motionLimit=.01,f._edgeRepulsion=.65,f._nodeRepulsion=.65,f._damper=1,f._maxMotion=0,f._motionRatio=0,f.init=function(o){var Z=this;o instanceof H?Z.dm=o:Z.gv=o,Z._nodeMap={},Z._nodes=new a,Z._edges=new a},f.start=function(){var E=this,S=E.gv;if(!E._timer){var i=E.cdm=S?S.dm():E.dm;i.mm(E.handleDataModelChange,E),i.md(E.handleDataPropertyChange,E),S&&S.mp(E.handleGV,E),i.each(function(Q){if(E.isVisible(Q)&&E.isLayoutable(Q)&&Q instanceof e)if(E instanceof z){var B=Q.p3();Q.p3([B[0]+T(),B[1]+T(),B[2]+T()])}else B=Q.p(),Q.p(B.x+T(),B.y+T())}),E._timer=setInterval(function(){E.relax()},E._interval),E._damper=1}},f.stop=function(){var k=this;k._timer&&(k.cdm.umm(k.handleDataModelChange,k),k.cdm.umd(k.handleDataPropertyChange,k),k.gv&&k.gv.ump(k.handleGV,k),clearInterval(k._timer),delete k._timer,delete k.cdm)},f.handleGV=function(D){var h=this;if("dataModel"===D.property){var s=D.oldValue,t=D.newValue;s&&(s.umm(h.handleDataModelChange,h),s.umd(h.handleDataPropertyChange,h)),this.cdm=t,t.mm(h.handleDataModelChange,h),t.md(h.handleDataPropertyChange,h)}},f.relax=function(){var c=this;if(!(c._damper<.1&&c._maxMotion<c._motionLimit)){this.cdm.each(function(z){c.isVisible(z)&&(z instanceof t?c.addEdge(z):z instanceof e&&c.addNode(z))});for(var v,D,k=0,i=c._edges,O=c._nodes,j=O.size();k<c._stepCount;k++){for(i.each(c.relaxEdge,c),v=0;j>v;v++)for(D=0;j>D;D++)c.relaxNode(O.get(v),O.get(D));c.moveNode()}c._isAdjusting=1,O.each(function(Q){Q.fix||(Q.p?Q.v.p3(Q.p):Q.v.p(Q.x,Q.y))}),delete c._isAdjusting,c._nodeMap={},O.clear(),i.clear(),c.onRelaxed()}},f.onRelaxed=function(){},f.isRunning=function(){return!!this._timer},f.isVisible=function(L){return L.s("layoutable")===!1?!1:this.gv?this.gv.isVisible(L):!0},f.isLayoutable=function(Y){if(Y.s("layoutable")===!1)return!1;if(Y instanceof b)return!1;var A=this;return A.gv?A.gv.isMovable(Y)&&!A.gv.isSelected(Y):!(A.cdm||A.dm).sm().co(Y)},f.getNodeRepulsion=function(){return this._nodeRepulsion},f.setNodeRepulsion=function(J){this._nodeRepulsion=J,this._damper=1},f.getEdgeRepulsion=function(){return this._edgeRepulsion},f.setEdgeRepulsion=function(W){this._edgeRepulsion=W,this._damper=1},f.getStepCount=function(){return this._stepCount},f.setStepCount=function(G){this._stepCount=G,this._damper=1},f.getInterval=function(){return this._interval},f.setInterval=function(D){var J=this;J._interval!==D&&(J._interval=D,J._timer&&(clearInterval(J._timer),J._timer=setInterval(function(){J.relax()},D)))},f.handleDataPropertyChange=function(a){!this._isAdjusting&&this.isVisible(a.data)&&(this._damper=1)},f.handleDataModelChange=function(){this._damper=1},f.damp=function(){var g=this._maxMotion,j=this._damper;this._motionRatio<=.001&&((.2>g||g>1&&.9>j)&&j>.01?this._damper-=.01:.4>g&&j>.003?this._damper-=.003:j>1e-4&&(this._damper-=1e-4)),g<this._motionLimit&&(this._damper=0)}}}),M.layout.ForceLayout=function(L){this.init(L)},M.Default.def(I+"ForceLayout",C,{ms_force:1,getLimitBounds:function(){return this._limitBounds},setLimitBounds:function(v){this._limitBounds=v,this._damper=1},getNodeSize:function(F){var L=this.gv;return L&&L.getDataUIBounds?L.getDataUIBounds(F):F.getRect()},addNode:function(D){var C=this,M=C._nodeMap[D._id];if(M)return M;var v=D.p();M={v:D,x:v.x,y:v.y,dx:0,dy:0,fix:!C.isLayoutable(D),s:C.getNodeSize(D)};var L=M.s,l=x(q(L.width)+q(L.height))*C._nodeRepulsion;return M.r=1>l?100:l,C._nodeMap[D._id]=M,C._nodes.add(M),M},addEdge:function(y){if(y._40I&&y._41I){var i=this,R=i.addNode(y._40I),D=i.addNode(y._41I),P={s:R,t:D};D=D.s,R=R.s;var a=D.width+R.width,r=D.height+R.height;P.length=x(a*a+r*r)*i._edgeRepulsion,P.length<=0&&(P.length=100),i._edges.add(P)}},relaxEdge:function(f){var Y=f.t,m=f.s,N=Y.x-m.x,X=Y.y-m.y,Z=x(N*N+X*X),V=100*f.length,h=.25*N/V*Z,F=.25*X/V*Z;Y.dx=Y.dx-h,Y.dy=Y.dy-F,m.dx=m.dx+h,m.dy=m.dy+F},relaxNode:function(F,b){if(F!==b){var Q=0,W=0,x=F.x-b.x,H=F.y-b.y,$=x*x+H*H;0===$?(Q=T(),W=T()):36e4>$&&(Q=x/$,W=H/$);var N=F.r*b.r/400;Q*=N,W*=N,F.dx+=Q,F.dy+=W,b.dx-=Q,b.dy-=W}},moveNode:function(){var l=this,R=l._limitBounds,b=l._maxMotion,d=0,u=l._damper;l._nodes.each(function(f){if(!f.fix){var Q=f.dx*u,q=f.dy*u;if(f.dx=Q/2,f.dy=q/2,d=n(x(Q*Q+q*q),d),f.x+=n(-40,V(40,Q)),f.y+=n(-40,V(40,q)),R){f.x<R.x&&(f.x=R.x,l.adjust(1,0)),f.y<R.y&&(f.y=R.y,l.adjust(0,1));var i=f.s;f.x+i.width>R.x+R.width&&(f.x=R.x+R.width-i.width,l.adjust(-1,0)),f.y+i.height>R.y+R.height&&(f.y=R.y+R.height-i.height,l.adjust(0,-1))}}}),l._maxMotion=d,l._motionRatio=d>0?b/d-1:0,l.damp()},adjust:function(v,$){var r=this._limitBounds;this._nodes.each(function(C){v>0?(!r||C.x+C.s.width+v<r.x+r.width)&&(C.x+=v):(!r||C.x+v>r.x)&&(C.x+=v),$>0?(!r||C.y+C.s.height+$<r.y+r.height)&&(C.y+=$):(!r||C.y+$>r.y)&&(C.y+=$)})}});var z=M.layout.Force3dLayout=function(C){this.init(C)};M.Default.def(I+"Force3dLayout",C,{ms_force:1,getNodeSize3d:function(E){return E.s3()},addNode:function(o){var S=this,r=S._nodeMap[o._id];if(r)return r;r={v:o,p:o.p3(),d:[0,0,0],fix:!S.isLayoutable(o),s:S.getNodeSize3d(o)};var B=r.s,A=M.Default.getDistance(B)*S._nodeRepulsion;return r.r=1>A?100:A,S._nodeMap[o._id]=r,S._nodes.add(r),r},addEdge:function(U){if(U._40I&&U._41I){var l=this,o=l.addNode(U._40I),v=l.addNode(U._41I),H={s:o,t:v};v=v.s,o=o.s,H.length=x(q(v[0]+o[0])+q(v[1]+o[1])+q(v[2]+o[2]))*l._edgeRepulsion,H.length<=0&&(H.length=100),l._edges.add(H)}},relaxEdge:function(j){var r=j.t.p,E=j.s.p,O=j.t.d,J=j.s.d,Q=r[0]-E[0],c=r[1]-E[1],h=r[2]-E[2],K=x(Q*Q+c*c+h*h),l=100*j.length,q=.25*Q/l*K,$=.25*c/l*K,C=.25*h/l*K;O[0]-=q,O[1]-=$,O[2]-=C,J[0]+=q,J[1]+=$,J[2]+=C},relaxNode:function(s,b){if(s!==b){var d=s.p,W=b.p,u=0,w=0,$=0,g=d[0]-W[0],h=d[1]-W[1],r=d[2]-W[2],I=g*g+h*h+r*r;0===I?(u=T(),w=T(),$=T()):216e6>I&&(u=g/I,w=h/I,$=r/I);var R=s.r*b.r/400,j=s.d,e=b.d;u*=R,w*=R,$*=R,j[0]+=u,j[1]+=w,j[2]+=$,e[0]-=u,e[1]-=w,e[2]-=$}},moveNode:function(){var Y=this,T=Y._maxMotion,S=0,Q=Y._damper;Y._nodes.each(function(v){if(!v.fix){var b=v.p,$=v.d,C=$[0]*Q,p=$[1]*Q,M=$[2]*Q;$[0]=C/2,$[1]=p/2,$[2]=M/2,S=n(x(C*C+p*p+M*M),S),b[0]+=n(-40,V(40,C)),b[1]+=n(-40,V(40,p)),b[2]+=n(-40,V(40,M))}}),Y._maxMotion=S,Y._motionRatio=S>0?T/S-1:0,Y.damp()}})}(this,Object);